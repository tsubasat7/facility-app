<script>
// JSONデータ
let TRAITS={}, STORY={}, META={}, COMPAT={};
let loaded = false;

// ロード中はボタン無効化
function disableButtons(){
  document.querySelectorAll("button.run").forEach(btn=>{
    btn.disabled = true;
    btn.style.opacity = "0.5";
    btn.textContent = "読み込み中…";
  });
}
function enableButtons(){
  document.querySelectorAll("button.run").forEach(btn=>{
    btn.disabled = false;
    btn.style.opacity = "1";
    if(btn.innerText.includes("診断")) btn.textContent = "診断する";
    if(btn.innerText.includes("相性")) btn.textContent = "相性を見る";
    if(btn.innerText.includes("グループ")) btn.textContent = "グループ診断実行";
  });
}

// JSON ロード
async function loadAll(){
  disableButtons();
  try{
    const t = fetch("data/traits.json").then(r=>r.json());
    const s = fetch("data/story.json").then(r=>r.json());
    const m = fetch("data/meta.json").then(r=>r.json());
    const c = fetch("data/compatibility.json").then(r=>r.json());

    const [T,S,M,C] = await Promise.all([t,s,m,c]);

    TRAITS = T;
    STORY  = S;
    META   = M;
    COMPAT = C;

    loaded = true;
    enableButtons();
    console.log("JSON すべて読み込み完了");

  }catch(e){
    alert("データ読み込みに失敗しました");
    console.error(e);
  }
}
loadAll();


// ■ 個別診断
function analyzeSingle(){
  if(!loaded){ alert("データ読み込み中です…"); return; }

  const name   = document.getElementById("single_name").value || "未入力";
  const birth  = document.getElementById("single_birth").value || "未入力";
  const meisuu = Number(document.getElementById("single_meisuu").value);

  if(!meisuu || meisuu<1 || meisuu>60){
    alert("命数は 1〜60 で入力してください");
    return;
  }

  const t = TRAITS[meisuu];
  const s = STORY[meisuu];
  const m = META[meisuu];

  if(!t || !s || !m){
    alert("データが未登録の命数です");
    return;
  }

  document.getElementById("single_result").innerHTML = `
    <div class="card">
      <h3>${name} さん</h3>
      <p><b>命数：</b>${meisuu}</p>
      <p><b>守護星座：</b>${m.zodiac}（${m.type}）</p>
      <p><b>生年月日：</b>${birth}</p>

      <h4>■ 性格・核</h4>
      <p>${t.core}</p>

      <h4>■ 過去ストーリー</h4>
      <p>${s.past}</p>
    </div>
  `;
}


// ■ 2名相性
function analyzePair(){
  if(!loaded){ alert("データ読み込み中です…"); return; }

  const a = Number(document.getElementById("pair_a").value);
  const b = Number(document.getElementById("pair_b").value);

  if(!a || !b){ alert("命数を入力"); return; }

  const key = `${a}-${b}`;
  const val = COMPAT[key] || "相性データなし";

  document.getElementById("pair_result").innerHTML = `
    <div class="card">
      <h3>命数 ${a} × ${b}</h3>
      <p>${val}</p>
    </div>
  `;
}


// ■ グループ追加
function addMember(){
  const area = document.getElementById("group_area");
  const div = document.createElement("div");
  div.className = "member-block";
  div.innerHTML = `
    <label>名前</label>
    <input class="g_name">

    <label>生年月日（記録用）</label>
    <input class="g_birth" type="date">

    <label>命数（1〜60）</label>
    <input class="g_meisuu" type="number" min="1" max="60">
  `;
  area.appendChild(div);
}


// ■ グループ診断
function analyzeGroup(){
  if(!loaded){ alert("データ読み込み中です…"); return; }

  const blocks = document.querySelectorAll(".member-block");

  if(blocks.length===0){
    alert("人数を追加してください");
    return;
  }

  let members = [];

  blocks.forEach(b=>{
    const name = b.querySelector(".g_name").value || "未入力";
    const birth = b.querySelector(".g_birth").value || "";
    const m = Number(b.querySelector(".g_meisuu").value);

    if(!m) return;

    members.push({
      name,
      birth,
      meisuu:m,
      trait:TRAITS[m],
      story:STORY[m],
      meta:META[m]
    });
  });

  if(members.length===0){
    alert("命数が入力されていません");
    return;
  }

  let html = `<div class="card"><h3>■ 個別診断結果一覧</h3>`;
  members.forEach(p=>{
    html += `
      <div class="member-block">
        <b>${p.name}</b><br>
        命数：${p.meisuu}<br>
        守護星座：${p.meta.zodiac}（${p.meta.type}）<br>
        <b>性格：</b>${p.trait.core}<br>
        <b>過去：</b>${p.story.past}
      </div>
    `;
  });
  html += `</div>`;

  html += `<div class="card"><h3>■ グループ相性</h3>`;
  for(let i=0;i<members.length;i++){
    for(let j=i+1;j<members.length;j++){
      const a = members[i].meisuu;
      const b = members[j].meisuu;
      const key = `${a}-${b}`;
      const val = COMPAT[key] || "相性データなし";

      html += `
        <div class="member-block">
          <b>${members[i].name} × ${members[j].name}</b><br>
          命数 ${a} × ${b}<br>
          <p>${val}</p>
        </div>
      `;
    }
  }
  html += `</div>`;

  document.getElementById("group_result").innerHTML = html;
}
</script>
