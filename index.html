<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é‹å‘½ã®å…­å±æ€§è¨ºæ–­ï¼ˆå†…éƒ¨ãƒ„ãƒ¼ãƒ«ï¼‰</title>

<style>
body{font-family:sans-serif;background:#fafafa;margin:0}
header{padding:16px;border-bottom:1px solid #ddd;background:#fff}
.container{max-width:1000px;margin:auto;padding:20px}
.card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px;margin-bottom:20px}
h3{margin-top:0}
button{padding:10px 16px;border-radius:20px;border:1px solid #555;cursor:pointer;background:#fff}
button.run{background:#222;color:#fff;border:none}
button[disabled]{opacity:0.5;cursor:not-allowed;}
input,select{padding:8px;border:1px solid #ccc;border-radius:8px;width:100%}
.flex{display:flex;gap:20px}
.member-block{border:1px dashed #aaa;padding:16px;border-radius:12px;margin-bottom:16px;background:#fefefe}
</style>
</head>

<body>

<header>
<h2>ğŸ”® é‹å‘½ã®å…­å±æ€§è¨ºæ–­ï¼ˆå†…éƒ¨ãƒ„ãƒ¼ãƒ«ï¼‰</h2>
<small>å®Œå…¨ç‰ˆ / GitHub Pages å¯¾å¿œ</small>
</header>

<div class="container">

<!-- å€‹åˆ¥è¨ºæ–­ -->
<div class="card">
<h3>â–  å€‹åˆ¥è¨ºæ–­</h3>

<div class="flex">
<div style="flex:1">
<label>åå‰</label>
<input id="single_name">
</div>

<div style="flex:1">
<label>ç”Ÿå¹´æœˆæ—¥ï¼ˆè¨˜éŒ²ç”¨ï¼‰</label>
<input id="single_birth" type="date">
</div>

<div style="flex:1">
<label>å‘½æ•°ï¼ˆ1ã€œ60ï¼‰</label>
<input id="single_meisuu" type="number" min="1" max="60">
</div>
</div>

<br>
<button class="run" id="btn_single" disabled>èª­ã¿è¾¼ã¿ä¸­â€¦</button>
</div>

<div id="single_result"></div>


<!-- ç›¸æ€§è¨ºæ–­ -->
<div class="card">
<h3>â–  ç›¸æ€§è¨ºæ–­ï¼ˆ2äººï¼‰</h3>

<div class="flex">
<div style="flex:1">
<label>æœ¬äººã®å‘½æ•°</label>
<input id="pair_a" type="number" min="1" max="60">
</div>

<div style="flex:1">
<label>ç›¸æ‰‹ã®å‘½æ•°</label>
<input id="pair_b" type="number" min="1" max="60">
</div>
</div>

<br>
<button class="run" id="btn_pair" disabled>èª­ã¿è¾¼ã¿ä¸­â€¦</button>
</div>

<div id="pair_result"></div>


<!-- ã‚°ãƒ«ãƒ¼ãƒ—è¨ºæ–­ -->
<div class="card">
<h3>â–  ã‚°ãƒ«ãƒ¼ãƒ—è¨ºæ–­ï¼ˆè¤‡æ•°åï¼‰</h3>
<div id="group_area"></div>

<button id="btn_add" disabled>ï¼‹ äººã‚’è¿½åŠ </button>
<button class="run" id="btn_group" disabled>èª­ã¿è¾¼ã¿ä¸­â€¦</button>
</div>

<div id="group_result"></div>

</div> <!-- container -->


<script>
/* ===============================
   ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿
================================ */
let TRAITS={}, STORY={}, META={}, ATTR={}, COMPAT={};

/* ===============================
   Safe JSON Loader
================================ */
async function safeLoad(url, fallback={}){
  try{
    const res = await fetch(url,{cache:"no-store"});
    if(!res.ok) throw new Error(res.status);
    return await res.json();
  }catch(e){
    console.warn("èª­ã¿è¾¼ã¿å¤±æ•—:",url,e);
    return fallback;
  }
}

/* ===============================
   ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–ï¼ˆ1ã€œ60ä¿è¨¼ï¼‰
================================ */
function normalize60(obj, def){
  const out={};
  for(let i=1;i<=60;i++){
    out[i] = obj?.[i] ?? def;
  }
  return out;
}

/* ===============================
   å…¨ãƒ­ãƒ¼ãƒ‰
================================ */
async function init(){
  TRAITS = normalize60(
    await safeLoad("data/traits.json"),
    { core:"æœªå®šç¾©" }
  );

  STORY = normalize60(
    await safeLoad("data/story.json"),
    { past:"æœªå®šç¾©" }
  );

  META = normalize60(
    await safeLoad("data/meta.json"),
    { zodiac:"ä¸æ˜", type:"" }
  );

  ATTR = normalize60(
    await safeLoad("data/attributes.json"),
    { attribute:"ä¸æ˜" }
  );

  COMPAT = await safeLoad("data/compatibility.json");

  document.getElementById("btn_single").disabled=false;
  document.getElementById("btn_single").textContent="è¨ºæ–­ã™ã‚‹";

  document.getElementById("btn_pair").disabled=false;
  document.getElementById("btn_pair").textContent="ç›¸æ€§ã‚’è¦‹ã‚‹";

  console.log("åˆæœŸåŒ–å®Œäº†ï¼ˆ1ã€œ60æ­£è¦åŒ–æ¸ˆï¼‰");
}
init();

/* ===============================
   å€‹åˆ¥è¨ºæ–­
================================ */
document.getElementById("btn_single").onclick=()=>{
  const name=document.getElementById("single_name").value||"æœªå…¥åŠ›";
  const birth=document.getElementById("single_birth").value||"";
  const m=Number(document.getElementById("single_meisuu").value);

  if(!Number.isInteger(m)||m<1||m>60){
    alert("å‘½æ•°ã¯1ã€œ60ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const t = TRAITS[m].core;
  const s = STORY[m].past;
  const meta = META[m];

  document.getElementById("single_result").innerHTML=`
  <div class="card">
    <h3>${name}</h3>
    <p>å‘½æ•°ï¼š${m}</p>
    <p>å®ˆè­·æ˜Ÿåº§ï¼š${meta.zodiac} ${meta.type}</p>
    <p>ç”Ÿå¹´æœˆæ—¥ï¼š${birth}</p>
    <h4>æ€§æ ¼</h4><p>${t}</p>
    <h4>éå»</h4><p>${s}</p>
  </div>`;
};

/* ===============================
   ç›¸æ€§è¨ºæ–­ï¼ˆå®Œå…¨é˜²å¾¡ï¼‰
================================ */
function getCompatibility(a,b){
  if(a<1||a>60||b<1||b>60) return "å‘½æ•°ç¯„å›²ã‚¨ãƒ©ãƒ¼";

  const attrA = ATTR[a].attribute;
  const attrB = ATTR[b].attribute;

  if(attrA==="ä¸æ˜"||attrB==="ä¸æ˜"){
    return "å±æ€§ãƒ‡ãƒ¼ã‚¿ä¸è¶³";
  }

  const pair =
    COMPAT?.attribute_pair?.[attrA]?.[attrB] ??
    COMPAT?.attribute_pair?.[attrB]?.[attrA];

  if(!pair){
    return "ç›¸æ€§æœªå®šç¾©";
  }

  return `ç›¸æ€§ãƒ¬ãƒ™ãƒ«${pair.level}ï¼š${pair.comment}`;
}

document.getElementById("btn_pair").onclick=()=>{
  const a=Number(pair_a.value);
  const b=Number(pair_b.value);

  if(!Number.isInteger(a)||!Number.isInteger(b)){
    alert("å‘½æ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  document.getElementById("pair_result").innerHTML=`
  <div class="card">
    <h3>å‘½æ•° ${a} Ã— ${b}</h3>
    <p>${getCompatibility(a,b)}</p>
  </div>`;
};
</script>

</body>
</html>
